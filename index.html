import React, { useState, useEffect, useRef } from 'react';
import { Canvas, useFrame } from '@react-three/fiber';
import * as THREE from 'three';
import { OrbitControls, Text } from '@react-three/drei';
import { gsap } from 'gsap';
import { Howl } from 'howler';
import Confetti from 'react-confetti';

const App = () => {
  const [hasSpun, setHasSpun] = useState(false);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [showWinModal, setShowWinModal] = useState(false);
  const [result, setResult] = useState(null);
  const [windowSize, setWindowSize] = useState({
    width: window.innerWidth,
    height: window.innerHeight,
  });
  const [showConfetti, setShowConfetti] = useState(false);
  const wheelRef = useRef();

  // Sound effects
  const spinSound = new Howl({
    src: ['https://assets.codepen.io/3364143/spin-sound.mp3'],
    volume: 0.5,
  });

  const winSound = new Howl({
    src: ['https://assets.codepen.io/3364143/win-sound.mp3'],
    volume: 0.7,
  });

  const modalSound = new Howl({
    src: ['https://assets.codepen.io/3364143/modal-open.mp3'],
    volume: 0.3,
  });

  useEffect(() => {
    const handleResize = () => {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    };

    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const spinWheel = () => {
    if (hasSpun && !showPaymentModal) {
      setShowPaymentModal(true);
      modalSound.play();
      return;
    }

    spinSound.play();
    
    // Random result (50/50 chance)
    const spinResult = Math.random() > 0.5 ? 'Won â‚¹10,000' : 'Date Sophia';
    setResult(spinResult);

    // Animate the wheel
    gsap.to(wheelRef.current.rotation, {
      z: `+=${Math.PI * 10}`,
      duration: 4,
      ease: 'power3.out',
      onComplete: () => {
        setShowWinModal(true);
        setShowConfetti(true);
        winSound.play();
        setTimeout(() => setShowConfetti(false), 5000);
        
        if (!hasSpun) {
          setHasSpun(true);
        }
      }
    });
  };

  const handlePayment = () => {
    setShowPaymentModal(false);
    modalSound.play();
  };

  return (
    <div className="relative min-h-screen bg-black overflow-hidden">
      {/* Glowing background elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-purple-900 rounded-full filter blur-3xl opacity-20 animate-pulse"></div>
        <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-amber-600 rounded-full filter blur-3xl opacity-10 animate-pulse"></div>
        <div className="absolute top-1/3 right-1/3 w-48 h-48 bg-blue-600 rounded-full filter blur-3xl opacity-15"></div>
      </div>

      {/* Main content */}
      <div className="relative z-10 min-h-screen flex flex-col items-center justify-center p-4">
        <header className="w-full max-w-4xl flex justify-between items-center mb-8 p-4">
          <h1 className="text-3xl md:text-4xl font-bold bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
            LUXURY SPIN
          </h1>
          <div className="flex items-center space-x-4">
            <div className="bg-black bg-opacity-50 border border-amber-400 rounded-full px-4 py-2 flex items-center">
              <span className="text-gray-300 mr-2">Balance:</span>
              <span className="text-amber-400 font-bold">â‚¹0</span>
            </div>
          </div>
        </header>

        <main className="flex-1 w-full max-w-4xl flex flex-col items-center justify-center">
          {/* Wheel container */}
          <div className="relative w-full max-w-md aspect-square mb-8">
            <Canvas camera={{ position: [0, 0, 5], fov: 50 }}>
              <ambientLight intensity={0.5} />
              <pointLight position={[10, 10, 10]} intensity={1} color="#f59e0b" />
              <pointLight position={[-10, -10, -10]} intensity={0.5} color="#8b5cf6" />
              
              <Wheel ref={wheelRef} />
              
              <OrbitControls enabled={false} />
            </Canvas>
            
            {/* Spin arrow */}
            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10">
              <div className="w-0 h-0 border-l-8 border-r-8 border-b-16 border-l-transparent border-r-transparent border-b-amber-400 filter drop-shadow-[0_0_8px_rgba(245,158,11,0.7)]"></div>
            </div>
          </div>

          {/* Spin button */}
          <button
            onClick={spinWheel}
            className="relative overflow-hidden px-12 py-4 bg-gradient-to-b from-amber-400 to-amber-600 rounded-full text-black font-bold text-xl md:text-2xl shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 transition-all duration-300 hover:scale-105 active:scale-95"
          >
            <span className="relative z-10">SPIN TO WIN</span>
            <span className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent opacity-0 hover:opacity-100 animate-shine transition-opacity duration-300"></span>
          </button>
        </main>

        <footer className="w-full max-w-4xl mt-8 p-4 text-center text-gray-500 text-sm border-t border-gray-800">
          Â© {new Date().getFullYear()} Luxury Spin. Play responsibly.
        </footer>
      </div>

      {/* Payment Modal */}
      {showPaymentModal && (
        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
          <div className="relative bg-gradient-to-b from-gray-900 to-gray-800 rounded-xl max-w-md w-full p-8 border border-amber-400 shadow-lg shadow-amber-500/20">
            <button 
              onClick={() => setShowPaymentModal(false)}
              className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl"
            >
              &times;
            </button>
            
            <h2 className="text-2xl font-bold text-center mb-6 bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
              UNLOCK MORE SPINS
            </h2>
            
            <div className="mb-6 text-center text-gray-300">
              <p className="mb-4">Pay â‚¹99 via UPI to continue playing</p>
              <div className="bg-white p-4 rounded-lg mb-4 flex justify-center">
                <img 
                  src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=keanjohn72@oksbi&pn=LuxurySpin&am=99&cu=INR`} 
                  alt="UPI QR Code" 
                  className="w-48 h-48"
                />
              </div>
              <p className="text-sm text-gray-400">Scan or send to: keanjohn72@oksbi</p>
            </div>
            
            <div className="bg-gray-800 rounded-lg p-4 mb-6">
              <div className="flex justify-between items-center mb-2">
                <span className="text-gray-400">Amount:</span>
                <span className="text-amber-400 font-bold">â‚¹99</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-gray-400">UPI ID:</span>
                <span className="text-white">keanjohn72@oksbi</span>
              </div>
            </div>
            
            <button
              onClick={handlePayment}
              className="w-full py-3 bg-gradient-to-r from-purple-600 to-amber-500 rounded-lg font-bold text-white hover:opacity-90 transition-opacity"
            >
              I'VE MADE PAYMENT
            </button>
          </div>
        </div>
      )}

      {/* Win Modal */}
      {showWinModal && (
        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
          <div className="relative bg-gradient-to-b from-gray-900 to-gray-800 rounded-xl max-w-md w-full p-8 border border-amber-400 shadow-lg shadow-amber-500/20 text-center">
            <div className="text-6xl mb-4">ðŸŽ‰</div>
            <h2 className="text-2xl font-bold mb-2 bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
              CONGRATULATIONS!
            </h2>
            <p className="text-xl text-white mb-6">You {result}!</p>
            
            <div className="flex space-x-4">
              <button
                onClick={() => {
                  setShowWinModal(false);
                  spinSound.play();
                }}
                className="flex-1 py-3 bg-gradient-to-b from-amber-400 to-amber-600 rounded-lg font-bold text-black hover:opacity-90 transition-opacity"
              >
                SPIN AGAIN
              </button>
              <button
                onClick={() => {
                  setShowWinModal(false);
                  setShowPaymentModal(true);
                  modalSound.play();
                }}
                className="flex-1 py-3 bg-transparent border border-amber-400 rounded-lg font-bold text-amber-400 hover:bg-amber-400 hover:bg-opacity-10 transition-colors"
              >
                WITHDRAW
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Confetti */}
      {showConfetti && (
        <Confetti
          width={windowSize.width}
          height={windowSize.height}
          recycle={false}
          numberOfPieces={500}
          gravity={0.2}
        />
      )}
    </div>
  );
};

const Wheel = React.forwardRef((props, ref) => {
  const meshRef = useRef();
  const groupRef = useRef();
  
  useFrame(() => {
    if (groupRef.current) {
      groupRef.current.rotation.x += 0.005;
      groupRef.current.rotation.y += 0.01;
    }
  });

  // Create wheel segments
  const segments = [
    { color: '#8B5CF6', label: 'Won â‚¹10,000' }, // Purple
    { color: '#F59E0B', label: 'Date Sophia' },  // Amber
  ];

  const segmentAngle = (2 * Math.PI) / segments.length;

  React.useImperativeHandle(ref, () => ({
    rotation: meshRef.current?.rotation,
  }));

  return (
    <group ref={groupRef}>
      <mesh ref={meshRef} rotation={[0, 0, 0]}>
        <cylinderGeometry args={[3, 3, 0.5, segments.length, 1, true]} />
        <meshStandardMaterial
          side={THREE.DoubleSide}
          color="#111827"
          metalness={0.7}
          roughness={0.3}
        />
        
        {/* Segments */}
        {segments.map((segment, index) => {
          const angle = index * segmentAngle;
          return (
            <group key={index}>
              <mesh rotation={[0, 0, angle + segmentAngle / 2]}>
                <cylinderGeometry args={[3, 3, 0.51, 1, 1, false, angle, segmentAngle]} />
                <meshStandardMaterial
                  color={segment.color}
                  emissive={segment.color}
                  emissiveIntensity={0.2}
                  metalness={0.8}
                  roughness={0.2}
                />
              </mesh>
              
              {/* Text labels */}
              <Text
                position={[
                  Math.cos(angle + segmentAngle / 2) * 2.2,
                  Math.sin(angle + segmentAngle / 2) * 2.2,
                  0.26
                ]}
                rotation={[0, 0, angle + segmentAngle / 2 + Math.PI / 2]}
                color="white"
                fontSize={0.4}
                anchorX="center"
                anchorY="middle"
              >
                {segment.label}
              </Text>
            </group>
          );
        })}
        
        {/* Center circle */}
        <mesh position={[0, 0, 0.26]}>
          <circleGeometry args={[0.5, 32]} />
          <meshStandardMaterial color="#F59E0B" metalness={0.9} roughness={0.1} />
        </mesh>
        
        {/* Outer ring */}
        <mesh position={[0, 0, 0.25]}>
          <ringGeometry args={[2.9, 3, 64]} />
          <meshStandardMaterial color="#F59E0B" metalness={0.9} roughness={0.1} />
        </mesh>
      </mesh>
    </group>
  );
});

export default App;
